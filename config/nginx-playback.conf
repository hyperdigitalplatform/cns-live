# Nginx configuration for serving HLS segments efficiently

server {
    listen 80;
    server_name localhost;

    # Enable gzip compression for text files
    gzip on;
    gzip_types text/plain application/vnd.apple.mpegurl application/x-mpegURL;
    gzip_min_length 1000;

    # HLS manifest and segment serving
    location /hls/ {
        alias /tmp/playback/hls/;

        # CORS headers for web playback
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Range' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Length,Content-Range' always;

        # Cache control
        # M3U8 playlists - no cache (always fresh)
        location ~ \.m3u8$ {
            add_header Cache-Control 'no-cache, no-store, must-revalidate';
            add_header Pragma 'no-cache';
            add_header Expires '0';
            add_header 'Access-Control-Allow-Origin' '*' always;
        }

        # TS segments - cache for 1 hour (immutable)
        location ~ \.ts$ {
            add_header Cache-Control 'public, max-age=3600, immutable';
            add_header 'Access-Control-Allow-Origin' '*' always;
        }

        # Enable sendfile for efficient file serving
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        # Allow range requests for seeking
        add_header Accept-Ranges bytes;
    }

    # Video exports (MP4 downloads)
    location /exports/ {
        alias /tmp/playback/exports/;

        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;

        # Cache MP4 exports for 1 day
        add_header Cache-Control 'public, max-age=86400';

        # Enable sendfile
        sendfile on;
        tcp_nopush on;

        # Allow range requests
        add_header Accept-Ranges bytes;

        # Force download with proper filename
        if ($request_filename ~* ^.*/(.+\.(mp4|mkv|avi))$) {
            add_header Content-Disposition 'attachment; filename="$1"';
        }
    }

    # Proxy Milestone XProtect streams (handles SSL cert issues)
    location ~ ^/milestone/(.*)$ {
        # Proxy to Milestone server
        proxy_pass https://192.168.1.11/$1$is_args$args;
        proxy_http_version 1.1;

        # SSL configuration - accept self-signed certificate
        proxy_ssl_verify off;
        proxy_ssl_session_reuse on;

        # Preserve original host header
        proxy_set_header Host 192.168.1.11;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS headers for web playback
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Range, Authorization' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Longer timeouts for video streaming
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # Allow range requests for seeking
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;

        # Buffer settings for streaming
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Proxy API requests to playback service
    location /api/ {
        proxy_pass http://playback-service:8090;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Longer timeouts for video processing
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # Health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
