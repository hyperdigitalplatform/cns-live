# Kong Declarative Configuration for RTA CCTV System
# Format: kong.yml (declarative format)
# Version: 3.x

_format_version: "3.0"
_transform: true

###############################################
# SERVICES
###############################################

services:
  # Kong Health Check Service
  - name: kong-status
    url: http://localhost:8001
    protocol: http
    connect_timeout: 5000
    write_timeout: 5000
    read_timeout: 5000
    retries: 1
    tags:
      - kong
      - health

    routes:
      - name: kong-health
        paths:
          - /health
        methods:
          - GET
        strip_path: true
        preserve_host: false
        tags:
          - health
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /status

  # VMS Service - Milestone Integration
  - name: vms-service
    url: http://vms-service:8081
    protocol: http
    connect_timeout: 10000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags:
      - rta-cctv
      - vms

    routes:
      - name: vms-health
        paths:
          - /vms/health
        methods:
          - GET
        strip_path: true
        preserve_host: false
        tags:
          - health

      # Dashboard API routes - /api/v1/cameras/*
      - name: api-cameras-list
        paths:
          - /api/v1/cameras
        methods:
          - GET
          - OPTIONS
        strip_path: true
        preserve_host: false
        tags:
          - cameras
          - dashboard
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /vms/cameras

      - name: api-camera-detail
        paths:
          - /api/v1/cameras/~
        methods:
          - GET
          - OPTIONS
        strip_path: true
        preserve_host: false
        tags:
          - cameras
          - dashboard
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /vms/cameras/$(uri_captures[1])

      - name: api-camera-ptz
        paths:
          - /api/v1/cameras/~/ptz
        methods:
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
        tags:
          - ptz
          - dashboard
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /vms/cameras/$(uri_captures[1])/ptz

      # Original VMS routes (for direct access)
      - name: vms-cameras
        paths:
          - /vms/cameras
        methods:
          - GET
        strip_path: false
        preserve_host: false
        tags:
          - cameras

      - name: vms-camera-detail
        paths:
          - /vms/cameras/~
        methods:
          - GET
        strip_path: false
        tags:
          - cameras

      - name: vms-stream-url
        paths:
          - /vms/cameras/~/stream
        methods:
          - GET
        strip_path: false
        tags:
          - streaming

      - name: vms-ptz-control
        paths:
          - /vms/cameras/~/ptz
        methods:
          - POST
        strip_path: false
        tags:
          - ptz

      - name: vms-recordings-segments
        paths:
          - /vms/recordings/~/segments
        methods:
          - GET
        strip_path: false
        tags:
          - recordings

      - name: vms-recordings-export
        paths:
          - /vms/recordings/export
        methods:
          - POST
        strip_path: false
        tags:
          - recordings

      - name: vms-recordings-export-status
        paths:
          - /vms/recordings/export/~
        methods:
          - GET
        strip_path: false
        tags:
          - recordings

  # Go API Service - Central API for Dashboard
  - name: go-api-service
    url: http://go-api:8086
    protocol: http
    connect_timeout: 10000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags:
      - rta-cctv
      - api

    routes:
      - name: go-api-health
        paths:
          - /api/health
        methods:
          - GET
        strip_path: true
        preserve_host: false
        tags:
          - health

      # Stream management routes
      - name: stream-reserve
        paths:
          - /api/v1/stream/reserve
        methods:
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - streaming
          - dashboard

      - name: stream-release
        paths:
          - ~/api/v1/stream/release/[^/]+$
        methods:
          - DELETE
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - streaming
          - dashboard

      - name: stream-heartbeat
        paths:
          - ~/api/v1/stream/heartbeat/[^/]+$
        methods:
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - streaming
          - dashboard

      - name: stream-stats
        paths:
          - /api/v1/stream/stats
        methods:
          - GET
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - monitoring
          - dashboard
      # Camera and PTZ routes
      - name: api-cameras-ptz
        paths:
          - ~/api/v1/cameras/.*/ptz$
        methods:
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - ptz
          - cameras
          - dashboard

      - name: api-cameras-import
        paths:
          - /api/v1/cameras/import
        methods:
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - cameras
          - import
          - dashboard

      - name: api-cameras-all
        paths:
          - ~/api/v1/cameras(/.*)?$
        methods:
          - GET
          - POST
          - DELETE
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - cameras
          - dashboard

      # Layout management routes
      - name: api-layouts-all
        paths:
          - ~/api/v1/layouts(/.*)?$
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - layouts
          - dashboard

  # Milestone Service - Recording Control & Timeline
  - name: milestone-service
    url: http://milestone-service:8080
    protocol: http
    connect_timeout: 10000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags:
      - rta-cctv
      - milestone
      - recording

    routes:
      - name: milestone-health
        paths:
          - /milestone/health
        methods:
          - GET
        strip_path: true
        preserve_host: false
        tags:
          - health

      # Camera discovery route (must be before general cameras route)
      - name: milestone-cameras-discover
        paths:
          - /api/v1/milestone/cameras/discover
        methods:
          - GET
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - cameras
          - discovery
          - dashboard
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /api/v1/cameras/discover

      # Camera list route
      - name: milestone-cameras
        paths:
          - /api/v1/milestone/cameras
        methods:
          - GET
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - cameras
          - dashboard
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /api/v1/cameras

      # Recording control routes
      - name: milestone-start-recording
        paths:
          - /api/v1/milestone/recordings/start
        methods:
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - recording
          - dashboard

      - name: milestone-stop-recording
        paths:
          - /api/v1/milestone/recordings/stop
        methods:
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - recording
          - dashboard

      - name: milestone-recording-status
        paths:
          - ~/api/v1/milestone/recordings/status/[^/]+$
        methods:
          - GET
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - recording
          - dashboard

      # Sequence routes
      - name: milestone-sequence-types
        paths:
          - ~/api/v1/milestone/sequences/types/[^/]+$
        methods:
          - GET
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - sequences
          - dashboard
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /api/v1/sequences/types/$(uri_captures[1])

      - name: milestone-sequences
        paths:
          - /api/v1/milestone/sequences
        methods:
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - sequences
          - dashboard

      # Playback stream route
      - name: milestone-playback-stream
        paths:
          - ~/api/v1/cameras/[^/]+/playback/stream$
        methods:
          - GET
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - playback
          - dashboard

      # Timeline route
      - name: milestone-timeline
        paths:
          - /api/v1/milestone/timeline
        methods:
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: false
        tags:
          - timeline
          - dashboard
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /api/v1/timeline

  # Stream Counter Service - Internal Quota Management
  - name: stream-counter-service
    url: http://stream-counter:8087
    protocol: http
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 3
    tags:
      - rta-cctv
      - quota
      - internal

    routes:
      - name: stream-counter-health
        paths:
          - /internal/stream-counter/health
        methods:
          - GET
        strip_path: true
        preserve_host: false
        tags:
          - health

  # MediaMTX API - Stream Management
  - name: mediamtx-api
    url: http://mediamtx:9997
    protocol: http
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 3
    tags:
      - rta-cctv
      - streaming

    routes:
      - name: mediamtx-paths
        paths:
          - /api/v1/rtsp/paths
        methods:
          - GET
        strip_path: true
        request_buffering: false
        response_buffering: false
        tags:
          - admin
        # Rewrite to MediaMTX API
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /v3/paths/list

      - name: mediamtx-path-detail
        paths:
          - /api/v1/rtsp/paths/~
        methods:
          - GET
          - POST
          - DELETE
        strip_path: true
        tags:
          - admin
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /v3/paths/$(uri_captures[1])

###############################################
# GLOBAL PLUGINS
###############################################

plugins:
  # Request ID for tracing
  - name: correlation-id
    enabled: true
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true

  # CORS for RTA domains
  - name: cors
    enabled: true
    config:
      origins:
        - https://rta.ae
        - https://*.rta.ae
        - http://localhost:3000  # Development only
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-Type
        - Date
        - X-Auth-Token
        - X-Request-ID
        - Authorization
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
      credentials: true
      max_age: 3600
      preflight_continue: false

  # Request size limiting
  - name: request-size-limiting
    enabled: true
    config:
      allowed_payload_size: 10  # 10MB max
      size_unit: megabytes
      require_content_length: false

  # Response compression
  - name: response-transformer
    enabled: true
    config:
      add:
        headers:
          - "X-Powered-By: RTA CCTV System"
          - "X-Kong-Upstream-Status: $(upstream_status)"

  # Prometheus metrics
  - name: prometheus
    enabled: true
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

###############################################
# ROUTE-SPECIFIC PLUGINS
###############################################

# Rate limiting for stream reservation
# This is handled by Stream Counter Service, but Kong provides additional layer
# Example configuration (to be added to specific routes):
#
# - name: rate-limiting
#   route: stream-reserve
#   config:
#     minute: 60
#     hour: 1000
#     policy: local
#     fault_tolerant: true
#     hide_client_headers: false

# IP restriction for admin endpoints
# - name: ip-restriction
#   route: mediamtx-paths
#   config:
#     allow:
#       - 10.0.0.0/8
#       - 172.16.0.0/12
#       - 192.168.0.0/16

###############################################
# UPSTREAMS (for load balancing - future)
###############################################

# upstreams:
#   - name: vms-service-upstream
#     algorithm: round-robin
#     hash_on: none
#     hash_fallback: none
#     hash_on_cookie_path: /
#     slots: 10000
#     healthchecks:
#       active:
#         type: http
#         http_path: /health
#         timeout: 5
#         concurrency: 10
#         healthy:
#           interval: 30
#           successes: 2
#         unhealthy:
#           interval: 30
#           http_failures: 3
#           timeouts: 3
#     targets:
#       - target: vms-service:8081
#         weight: 100

###############################################
# CONSUMERS (for authentication - future)
###############################################

# consumers:
#   - username: rta-admin
#     custom_id: admin-001
#     tags:
#       - admin
#     keyauth_credentials:
#       - key: ${ADMIN_API_KEY}
#
#   - username: dubai-police-operator
#     custom_id: dp-001
#     tags:
#       - dubai-police
#       - operator
#     keyauth_credentials:
#       - key: ${DP_API_KEY}

###############################################
# CUSTOM PLUGINS (Lua)
###############################################

# Custom plugin for quota validation
# Located at: /usr/local/share/lua/5.1/kong/plugins/quota-validator/
#
# plugins:
#   - name: quota-validator
#     enabled: true
#     config:
#       stream_counter_url: http://stream-counter:8087
#       validate_before_proxy: true
#       cache_ttl: 5

###############################################
# NOTES
###############################################

# Deployment:
# 1. Development: Use DB-less mode with this declarative config
#    - kong start -c kong.conf --declarative-config kong.yml
#
# 2. Production: Use PostgreSQL database mode
#    - deck sync --config kong.yml
#
# Environment Variables:
# - KONG_DATABASE=off (for declarative mode)
# - KONG_DECLARATIVE_CONFIG=/etc/kong/kong.yml
# - KONG_PROXY_LISTEN=0.0.0.0:8000
# - KONG_ADMIN_LISTEN=0.0.0.0:8001
# - KONG_LOG_LEVEL=info
#
# Testing:
# - Validate config: kong config parse kong.yml
# - Check routes: curl http://localhost:8001/routes
# - Check services: curl http://localhost:8001/services
# - Check plugins: curl http://localhost:8001/plugins
#
# API Gateway URLs:
# - Proxy (client traffic): http://kong:8000
# - Admin API (management): http://kong:8001
# - Metrics: http://kong:8001/metrics

